@model KareClass.Models.Schedule

@{
    ViewData["Title"] = "Ders Programı Oluştur";
    var className = ViewData["ClassName"] as string;
    var classId = ViewData["ClassId"] as int?;
}

<div class="container">
    <h1>@className Sınıfı için Ders Programı Oluştur</h1>
    <hr />

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Ders Programı</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <input type="hidden" name="ClassId" value="@classId" />

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 25%">Zaman Dilimi</th>
                                        <th style="width: 35%">Ders</th>
                                        <th style="width: 40%">Öğretmen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var timeSlots = ViewData["TimeSlotId"] as SelectList;
                                        var courses = ViewData["CourseId"] as SelectList;
                                        var teachers = ViewData["TeacherId"] as SelectList;
                                        
                                        // Mevcut programları al
                                        var existingSchedules = ViewBag.ExistingSchedules as Dictionary<int, KareClass.Models.Schedule>;
                                    }

                                    @if (timeSlots != null)
                                    {
                                        int index = 0;
                                        foreach (var timeSlot in timeSlots)
                                        {
                                            var timeSlotId = int.Parse(timeSlot.Value);
                                            var hasExistingSchedule = existingSchedules != null && existingSchedules.ContainsKey(timeSlotId);
                                            var existingSchedule = hasExistingSchedule ? existingSchedules[timeSlotId] : null;
                                            
                                            <tr class="@(hasExistingSchedule ? "table-info" : "")">
                                                <td>
                                                    <input type="hidden" name="TimeSlotId[@index]" value="@timeSlot.Value" />
                                                    @timeSlot.Text
                                                    @if (hasExistingSchedule)
                                                    {
                                                        <span class="badge bg-info ms-2">Mevcut</span>
                                                    }
                                                </td>
                                                <td>
                                                    <select name="CourseId[@index]" class="form-select">
                                                        <option value="0">-- Ders Seçin --</option>
                                                        @foreach (var course in courses)
                                                        {
                                                            var isSelected = hasExistingSchedule && existingSchedule.CourseId.ToString() == course.Value;
                                                            if (isSelected)
                                                            {
                                                                <option value="@course.Value" selected>@course.Text</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@course.Value">@course.Text</option>
                                                            }
                                                        }
                                                    </select>
                                                </td>
                                                <td>
                                                    <select name="TeacherId[@index]" class="form-select">
                                                        <option value="0">-- Öğretmen Seçin --</option>
                                                        @foreach (var teacher in teachers)
                                                        {
                                                            var isSelected = hasExistingSchedule && existingSchedule.TeacherId.ToString() == teacher.Value;
                                                            if (isSelected)
                                                            {
                                                                <option value="@teacher.Value" selected>@teacher.Text</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@teacher.Value">@teacher.Text</option>
                                                            }
                                                        }
                                                    </select>
                                                </td>
                                            </tr>
                                            index++;
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Programı Kaydet
                            </button>
                            <button id="clearAll" class="btn btn-warning">
                                <i class="fas fa-eraser"></i> Tümünü Temizle
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Listeye Dön
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Ders seçildiğinde ilgili öğretmenleri filtrele
            $('select[name^="CourseId"]').change(function() {
                var courseId = $(this).val();
                var index = $(this).attr('name').match(/\d+/)[0];
                var teacherSelect = $('select[name="TeacherId[' + index + ']"]');
                
                if (courseId == 0) {
                    // Ders seçilmediğinde öğretmen seçimini sıfırla
                    teacherSelect.empty();
                    teacherSelect.append('<option value="0">-- Öğretmen Seçin --</option>');
                    return;
                }
                
                // AJAX ile seçilen derse göre öğretmenleri getir
                $.get('/Schedules/GetTeachersByCourse', { courseId: courseId }, function(teachers) {
                    teacherSelect.empty();
                    teacherSelect.append('<option value="0">-- Öğretmen Seçin --</option>');
                    
                    teachers.forEach(function(teacher) {
                        teacherSelect.append($('<option></option>')
                            .val(teacher.value)
                            .text(teacher.text));
                    });
                });
            });
            
            // Satır renklerini değiştir
            $('tr').hover(
                function() {
                    $(this).addClass('table-active');
                },
                function() {
                    $(this).removeClass('table-active');
                }
            );
            
            // Tüm dersleri temizle butonu
            $('#clearAll').click(function(e) {
                e.preventDefault();
                $('select[name^="CourseId"]').val(0);
                $('select[name^="TeacherId"]').val(0);
            });
        });
    </script>
}


